<!DOCTYPE html>
<html lang="ko" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub File Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { padding-top: 50px; padding-bottom: 50px; }
        .breadcrumb-item + .breadcrumb-item::before { content: "/"; }
        
        /* 우하단 테마 선택 버튼 스타일 */
        .theme-switches {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .list-group-item { cursor: pointer; transition: background 0.2s; }
        .list-group-item:hover { background-color: rgba(0,0,0,0.05); }
        [data-bs-theme="dark"] .list-group-item:hover { background-color: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <h1 id="repo-title" class="mb-3 fw-bold">Loading...</h1>
                
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb" id="breadcrumb"></ol>
                </nav>

                <div class="card shadow-sm">
                    <ul class="list-group list-group-flush" id="file-list">
                        <li class="list-group-item text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div class="mt-2">파일을 불러오는 중...</div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="theme-switches dropdown">
        <button class="btn btn-primary btn-lg rounded-circle shadow" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-circle-half"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><button class="dropdown-item" data-bs-theme-value="light"><i class="bi bi-sun-fill me-2"></i> Light</button></li>
            <li><button class="dropdown-item" data-bs-theme-value="dark"><i class="bi bi-moon-stars-fill me-2"></i> Dark</button></li>
            <li><button class="dropdown-item active" data-bs-theme-value="auto"><i class="bi bi-palette2 me-2"></i> Auto</button></li>
        </ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /** 테마 제어 로직 (Bootstrap 공식 가이드 기반) **/
        const getStoredTheme = () => localStorage.getItem('theme');
        const setStoredTheme = theme => localStorage.setItem('theme', theme);

        const getPreferredTheme = () => {
            const storedTheme = getStoredTheme();
            if (storedTheme) return storedTheme;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        const setTheme = theme => {
            if (theme === 'auto') {
                document.documentElement.setAttribute('data-bs-theme', (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme);
            }
        };

        // 테마 변경 버튼 클릭 이벤트
        window.addEventListener('DOMContentLoaded', () => {
            setTheme(getPreferredTheme());

            document.querySelectorAll('[data-bs-theme-value]').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const theme = toggle.getAttribute('data-bs-theme-value');
                    setStoredTheme(theme);
                    setTheme(theme);
                    
                    // UI 업데이트 (체크 표시 등)
                    document.querySelectorAll('[data-bs-theme-value]').forEach(el => el.classList.remove('active'));
                    toggle.classList.add('active');
                });
            });
        });

        /** 파일 탐색 로직 (이전 로직 유지/개선) **/
        const user = window.location.hostname.split('.')[0];
        const repo = window.location.pathname.split('/')[1] || "My Repo";
        const urlParams = new URLSearchParams(window.location.search);
        const currentPath = urlParams.get('path') || "";

        async function renderFiles() {
    const fileListElement = document.getElementById('file-list');
    document.getElementById('repo-title').innerText = repo;
    updateBreadcrumb();

    try {
        const response = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${currentPath}`);
        const items = await response.json();

        fileListElement.innerHTML = '';

        // 상위 폴더 가기
        if (currentPath !== "") {
            addFileItem('.. (상위 폴더)', `?path=${getParentPath(currentPath)}`, 'bi-arrow-90deg-up', true);
        }

        if (!Array.isArray(items)) throw new Error();

        items.forEach(item => {
            if (item.path === 'index.html') return;
            
            const isDir = item.type === 'dir';
            const icon = isDir ? 'bi-folder-fill text-warning' : 'bi-file-earmark-text text-secondary';
            
            // 핵심 수정 부분: 
            // 폴더면 쿼리 파라미터 유지, 파일이면 실제 호스팅 경로로 연결
            let link;
            if (isDir) {
                link = `?path=${encodeURIComponent(item.path)}`;
            } else {
                // 현재 URL 구조를 기반으로 실제 파일 경로 생성
                // 예: https://user.github.io/repo/path/to/file.html
                const baseUrl = window.location.origin + window.location.pathname;
                link = baseUrl + (baseUrl.endsWith('/') ? '' : '/') + item.path;
            }

            addFileItem(item.name, link, icon, false);
        });
    } catch (e) {
        fileListElement.innerHTML = '<li class="list-group-item text-danger text-center">API 호출 제한이거나 잘못된 경로입니다.</li>';
    }
}

        function addFileItem(name, link, iconClass, isBack) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex align-items-center py-3';
            li.innerHTML = `
                <i class="bi ${iconClass} me-3 fs-5"></i>
                <a href="${link}" class="text-decoration-none flex-grow-1 stretched-link ${isBack ? 'text-muted' : 'text-body-emphasis'}">${name}</a>
                <i class="bi bi-chevron-right text-muted small"></i>
            `;
            document.getElementById('file-list').appendChild(li);
        }

        function getParentPath(path) {
            const parts = path.split('/');
            parts.pop();
            return parts.join('/');
        }

        function updateBreadcrumb() {
            const bc = document.getElementById('breadcrumb');
            let html = `<li class="breadcrumb-item"><a href="?path=" class="text-decoration-none"><i class="bi bi-house-door"></i></a></li>`;
            const parts = currentPath.split('/').filter(p => p);
            let accumulatedPath = "";
            parts.forEach((part, index) => {
                accumulatedPath += (accumulatedPath ? '/' : '') + part;
                const isLast = index === parts.length - 1;
                html += `<li class="breadcrumb-item ${isLast ? 'active' : ''}">
                    ${isLast ? part : `<a href="?path=${encodeURIComponent(accumulatedPath)}" class="text-decoration-none">${part}</a>`}
                </li>`;
            });
            bc.innerHTML = html;
        }

        renderFiles();
    </script>
</body>
</html>
